{
  "project": "Organizations & Teams",
  "branchName": "flow/organizations-teams",
  "description": "Right now: 1 developer = 1 project. Reality: Production teams have multiple members, roles, client handoffs. Organizations enable multi-member projects with role-based access control.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Organizations Table",
      "description": "As a platform engineer, I want an organizations table so that I can support multi-tenant team structures.",
      "acceptanceCriteria": [
        "organizations table created in control_plane schema",
        "Columns: id, name, slug, owner_id (REFERENCES developers(id)), created_at",
        "slug is unique",
        "Index on owner_id",
        "Migration script created and tested",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Created migration 003_create_organizations_table.sql with organizations table in control_plane schema. Includes id (UUID PK), name, slug (unique), owner_id (FK to developers.id), created_at. Indexes on owner_id and slug. Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Create Organization Members Table",
      "description": "As a platform engineer, I want an organization_members table so that I can track team membership.",
      "acceptanceCriteria": [
        "organization_members table created in control_plane schema",
        "Columns: org_id (REFERENCES organizations(id)), user_id (REFERENCES developers(id)), role, invited_by, joined_at",
        "Composite primary key on (org_id, user_id)",
        "Role enum: owner, admin, developer, viewer",
        "Migration script created and tested",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Created migration 004_create_organization_members_table.sql with organization_members table in control_plane schema. Includes org_id (FK to organizations.id), user_id (FK to developers.id), role (enum: owner, admin, developer, viewer), invited_by, joined_at, created_at. Composite PK on (org_id, user_id). Indexes on user_id, org_id, and role. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Add Organization to Projects",
      "description": "As a platform engineer, I want projects to belong to organizations so that teams can share projects.",
      "acceptanceCriteria": [
        "projects table updated with organization_id column",
        "Foreign key to organizations table",
        "Nullable (personal projects have NULL)",
        "Migration script created",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Created migration 005_add_organization_to_projects.sql adding organization_id column to projects table. Nullable FK to control_plane.organizations(id) with ON DELETE SET NULL. Indexes on organization_id and (organization_id, developer_id) for efficient org-based queries. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Define Permission Matrix",
      "description": "As a platform engineer, I want a permission matrix defined so that roles have clear capabilities.",
      "acceptanceCriteria": [
        "Permissions defined per role",
        "Owner: delete projects, manage services, manage keys, manage users, use services",
        "Admin: manage services, manage keys, view logs, use services",
        "Developer: view logs, use services",
        "Viewer: view logs, read-only access",
        "Documented in code",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Added OrganizationRole enum (owner, admin, developer, viewer) and OrganizationPermission enum (delete_projects, manage_services, manage_keys, manage_users, view_logs, use_services). Created ORGANIZATION_PERMISSION_MATRIX constant documenting all role permissions. Added helper functions: hasOrganizationPermission(), requireOrganizationPermission(), getOrganizationRole(), requireOrganizationMembershipPermission(). Documented in src/features/abuse-controls/lib/authorization.ts. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Implement Create Organization",
      "description": "As a developer, I want to create an organization so that my team can collaborate on projects.",
      "acceptanceCriteria": [
        "POST /api/organizations endpoint",
        "Request: name, slug",
        "Creates organization with authenticated user as owner",
        "Returns organization details",
        "Generates unique slug if not provided",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Implemented POST /api/organizations endpoint in developer portal API. Accepts name and optional slug. Validates input (name: 2-255 chars, slug: 2-100 chars, lowercase letters/numbers/hyphens only). Forwards to control plane API at /api/v1/orgs which creates organization with authenticated user as owner. Slug generation is handled by control plane (generates from name if not provided, appends counter for duplicates). Returns organization details (id, name, slug, owner_id, created_at) with 201 status. Also implemented GET /api/organizations for listing organizations. Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Implement Invite Member",
      "description": "As a developer, I want to invite members to my organization by email so that my team can collaborate.",
      "acceptanceCriteria": [
        "POST /api/organizations/:id/members endpoint",
        "Request: email, role",
        "Sends invitation email",
        "Creates pending membership",
        "Only owners/admins can invite",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Implemented POST /v1/orgs/:id/members endpoint for email-based invitations. Created migration 017 adding email, status, and invitation_token columns to organization_members table. Added inviteMemberSchema with email and role validation. Implemented secure token generation using crypto.randomBytes(32). Created email service (control-plane-api/src/lib/email.ts) with sendOrganizationInvitationEmail function that sends HTML invitation emails with accept link. Endpoint validates ownership/admin access, checks for existing invitations (PENDING_INVITATION) or memberships (ALREADY_MEMBER), creates pending membership with 7-day expiry, and sends invitation email. Only owners and admins can invite members. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Implement Accept Invitation",
      "description": "As a developer, I want to accept organization invitations so that I can join teams.",
      "acceptanceCriteria": [
        "POST /api/organizations/:id/accept endpoint",
        "Requires invitation token",
        "Sets membership to active",
        "Sets joined_at timestamp",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Implemented POST /v1/orgs/:id/accept endpoint for accepting organization invitations. Endpoint accepts invitation token in request body. Validates that the authenticated user's email matches the invitation email. Checks token expiry and returns 400 if expired. Updates organization_members record: sets user_id to authenticated user, status to 'accepted', and joined_at to current timestamp. Returns updated member details. Validates invitation exists, is pending, and matches both org_id and token. Typecheck passes."
    },
    {
      "id": "US-008",
      "title": "Implement Remove Member",
      "description": "",
      "acceptanceCriteria": [
        "DELETE /api/organizations/:id/members/:userId endpoint",
        "Only owners/admins can remove",
        "Cannot remove owner",
        "Revokes access to organization projects",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Control plane API DELETE /v1/orgs/:id/members/:userId endpoint already implemented with full validation: only owners/admins can remove members (via validateOrganizationOwnership), prevents removing organization owner, deletes member from organization_members table which revokes access to org projects. Added removeOrganizationMember method to ControlPlaneClient. Created developer portal DELETE /api/organizations/:id/members/:userId endpoint that forwards to control plane API with proper error handling (FORBIDDEN, NOT_FOUND, UNAUTHORIZED). Fixed error message to correctly state 'Only owners and admins can remove members'."
    },
    {
      "id": "US-009",
      "title": "Implement Update Member Role",
      "description": "",
      "acceptanceCriteria": [
        "PUT /api/organizations/:id/members/:userId endpoint",
        "Request: role",
        "Only owners can update roles",
        "Cannot change owner role",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Implemented PUT /api/organizations/:id/members/:userId endpoint for updating member roles. Added updateOrganizationMemberRole method to ControlPlaneClient that forwards to control plane API PUT /v1/orgs/:id/members/:userId. Created validation file src/lib/validation.ts with updateMemberRoleSchema (role enum: owner, admin, developer, viewer). Developer portal endpoint validates request body using Zod, handles errors (FORBIDDEN, NOT_FOUND, UNAUTHORIZED), and returns updated member details. Control plane API already implemented with full validation: only owners can update member roles (via validateOrganizationOwnership), prevents changing organization owner role, validates role enum, updates organization_members table. Typecheck passes."
    },
    {
      "id": "US-010",
      "title": "Create Organizations List UI",
      "description": "As a developer, I want to see my organizations so that I can switch between teams.",
      "acceptanceCriteria": [
        "Organizations page created at /dashboard/organizations",
        "Lists all organizations",
        "Shows name, member count, project count",
        "Create organization button",
        "Organization detail view",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Created organizations list page at /dashboard/organizations (src/app/dashboard/organizations/page.tsx). Lists all organizations with name, member count, and project count. Includes 'Create Organization' button with modal form for name and optional slug. Created organization detail view at /dashboard/organizations/[slug] (src/app/dashboard/organizations/[slug]/page.tsx) showing organization info, projects list, and members list with role badges. Created API endpoint /api/organizations/with-stats that fetches organizations with aggregated member and project counts. Updated control plane listProjectsQuerySchema to support organization_id filtering (control-plane-api/src/lib/validation.ts). Updated control plane projects GET route to filter by organization_id. Typecheck passes."
    },
    {
      "id": "US-011",
      "title": "Create Team Management UI",
      "description": "",
      "acceptanceCriteria": [
        "Team management page in organization settings",
        "Lists all members with roles",
        "Shows member status (active/pending)",
        "Invite member form",
        "Change role dropdown",
        "Remove member button",
        "Resend invitation button",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Enforce Organization Scoping",
      "description": "As a platform engineer, I want organization projects scoped so that members only see their org's projects.",
      "acceptanceCriteria": [
        "Project list filtered by organization membership",
        "Personal projects (org_id = NULL) only visible to owner",
        "Org projects visible to all org members",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/Organizations & Teams.md"
}