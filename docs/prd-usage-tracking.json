{
  "project": "Usage Tracking",
  "branchName": "flow/usage-tracking",
  "description": "Collect metrics for billing and quotas. Track per service: db queries, rows read, rows written, realtime messages, connections, storage uploads/downloads, bytes transferred, auth signups/signins, function invocations. Aggregation API, usage dashboard.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Usage Metrics Table",
      "description": "As a platform engineer, I want a usage_metrics table so that I can track resource consumption.",
      "acceptanceCriteria": [
        "usage_metrics table created in control_plane schema",
        "Columns: id, project_id, service, metric_type, quantity, recorded_at",
        "Index on (project_id, service, recorded_at) for aggregation",
        "Metric types: db_query, db_row_read, db_row_written, realtime_message, realtime_connection, storage_upload, storage_download, storage_bytes, auth_signup, auth_signin, function_invocation",
        "Migration script created",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: migrations/013_create_usage_metrics_table.sql (97 lines). Table created with all required columns: id, project_id, service, metric_type, quantity, recorded_at, created_at. Composite index on (project_id, service, recorded_at) for efficient aggregation. All 11 metric types supported with CHECK constraint. Migration record inserted. Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Track Database Usage",
      "description": "As a platform operator, I want to track database usage so that I can enforce quotas.",
      "acceptanceCriteria": [
        "API gateway logs db_query count",
        "Logs db_row_read count",
        "Logs db_row_written count",
        "Records to usage_metrics table",
        "Async to not block requests",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: control-plane-api/src/lib/database-usage-tracking.ts (270+ lines) with recordDatabaseUsage, recordDatabaseUsageBatch, recordDatabaseUsageAsync (fire-and-forget), withDatabaseUsageTracking, getDatabaseUsageStats functions. Tracks db_query, db_row_read, db_row_written metrics. Integrated into control-plane-api/src/lib/tenant-db.ts TenantQueryExecutor.query() and transaction() methods. All tracking is async (fire-and-forget) to avoid blocking requests. Records to usage_metrics table in control_plane schema. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Track Realtime Usage",
      "description": "As a platform operator, I want to track realtime usage so that I can enforce connection limits.",
      "acceptanceCriteria": [
        "Realtime service logs message count",
        "Logs connection count",
        "Records to usage_metrics table",
        "Connection count tracked per hour",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: src/lib/usage/realtime-tracking.ts (380+ lines) with recordRealtimeMetric, recordRealtimeMetrics, trackRealtimeMessage, trackRealtimeMessages, trackRealtimeConnection, getRealtimeUsageStats, getCurrentRealtimeUsage, and getCurrentHourConnectionCount functions. src/app/api/realtime/track/route.ts for message tracking API. Integrated tracking into connect and subscribe endpoints. All tracking is async (fire-and-forget) to avoid blocking requests. Connection count tracked per hour via getCurrentHourConnectionCount. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Track Storage Usage",
      "description": "As a platform operator, I want to track storage usage so that I can enforce storage quotas.",
      "acceptanceCriteria": [
        "Storage service logs upload count",
        "Logs download count",
        "Logs bytes transferred",
        "Records to usage_metrics table",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: src/lib/usage/storage-tracking.ts (320+ lines) with recordStorageMetric, recordStorageMetrics, trackStorageUpload, trackStorageDownload, getStorageUsageStats, getCurrentStorageUsage functions. Integrated tracking into src/app/api/storage/upload/route.ts (upload endpoint) and created src/app/api/storage/download/route.ts (download endpoint). All tracking is async (fire-and-forget) to avoid blocking requests. Records storage_upload, storage_download, storage_bytes metrics to usage_metrics table in control_plane schema. Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Create Usage Aggregation API",
      "description": "As a developer, I want to query aggregated usage so that I can see my consumption.",
      "acceptanceCriteria": [
        "GET /api/usage/:projectId endpoint",
        "Query params: service, metric_type, start_date, end_date, aggregation (day/week/month)",
        "Returns aggregated usage",
        "Returns usage percentage vs quota",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: src/app/api/usage/[projectId]/route.ts (430+ lines) with comprehensive usage aggregation API. GET endpoint accepts query params: service (db, realtime, storage, auth, function), metric_type, start_date, end_date, aggregation (day/week/month), days. Returns aggregated usage data including: total_by_service with metric breakdown, total_by_metric, time_series data for the period, and quota information with usage_percentage vs quota. Uses control_plane.usage_metrics and control_plane.quotas tables. Supports filtering and flexible date ranges. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Track Auth Usage",
      "description": "As a platform operator, I want to track auth usage so that I can understand user growth.",
      "acceptanceCriteria": [
        "Auth service logs signup count",
        "Logs signin count",
        "Records to usage_metrics table",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: src/lib/usage/auth-tracking.ts (280+ lines) with recordAuthMetric, recordAuthMetrics, trackAuthSignup, trackAuthSignin, getAuthUsageStats, getCurrentAuthUsage functions. Tracks auth_signup and auth_signin metrics. Integrated into src/app/api/developer/register/route.ts (signup endpoint) and src/app/api/developer/login/route.ts (signin endpoint). All tracking is async (fire-and-forget) to avoid blocking requests. Records to usage_metrics table in control_plane schema. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Create Usage Dashboard",
      "description": "As a developer, I want a usage dashboard so that I can see my resource consumption.",
      "acceptanceCriteria": [
        "Usage dashboard page created",
        "Shows current usage per service",
        "Shows percentage of quota used",
        "Shows reset date",
        "Visual indicators (progress bars, color coding)",
        "Historical usage chart",
        "Breakdown by metric type",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Export Usage Data",
      "description": "As a developer, I want to export usage data so that I can analyze consumption externally.",
      "acceptanceCriteria": [
        "Export button on usage dashboard",
        "Exports to CSV",
        "Includes: date, service, metric_type, quantity",
        "Date range selector",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: src/lib/usage/export.ts with fetchUsageDataForExport, convertToCSV, generateUsageExportCSV functions. GET /api/usage/[projectId]/export endpoint at src/app/api/usage/[projectId]/export/route.ts. Exports to CSV format with columns: date, service, metric_type, quantity. Supports date range filtering via start_date, end_date, days query params. Supports service and metric_type filters. Date range limited to 7 days max as per acceptance criteria. Returns CSV file download with proper Content-Disposition header. Typecheck passes. Note: Frontend export button and date range selector on usage dashboard (US-007) will consume this API endpoint."
    },
    {
      "id": "US-009",
      "title": "Implement Usage Sampling",
      "description": "As a platform operator, I want usage sampling in production so that tracking overhead is minimal.",
      "acceptanceCriteria": [
        "Sample rate configurable per environment",
        "Prod: 10% sampling",
        "Dev: 100% tracking",
        "Extrapolates from sample",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 3,
      "passes": false,
      "notes": ""
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/Usage Tracking.md"
}