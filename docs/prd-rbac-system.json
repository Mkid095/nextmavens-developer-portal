{
  "project": "RBAC System",
  "branchName": "flow/rbac-system",
  "description": "Right now: Any logged-in user can do too much. Need: Explicit permissions based on role. RBAC enforces permission checks before actions and updates UI based on user capabilities.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Define Permissions",
      "description": "As a platform engineer, I want permissions defined so that I can enforce role-based access control.",
      "acceptanceCriteria": [
        "Permissions enum defined",
        "Permissions: projects.delete, projects.manage_services, projects.manage_keys, projects.manage_users, projects.view_logs, projects.use_services, database.write, database.read",
        "Documented in code",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Created src/lib/types/rbac.types.ts with Permission enum, Role enum, ROLE_PERMISSIONS mapping, hasPermission/canUserPerformAction functions, and metadata for UI display. Includes documentation for all permissions and roles."
    },
    {
      "id": "US-002",
      "title": "Define Role Permissions",
      "description": "As a platform engineer, I want role-permission mappings defined so that I can check permissions efficiently.",
      "acceptanceCriteria": [
        "Role permissions constant created",
        "Owner: all permissions",
        "Admin: all except projects.delete",
        "Developer: projects.view_logs, projects.use_services, database.read",
        "Viewer: projects.view_logs, database.read",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "ROLE_PERMISSIONS constant defined in src/lib/types/rbac.types.ts with correct mappings: Owner (all permissions), Admin (all except projects.delete and projects.manage_users - see US-008), Developer (view_logs, use_services, database.read), Viewer (view_logs, database.read). Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Create Permission Checker",
      "description": "As a platform engineer, I want a permission checker function so that I can enforce permissions.",
      "acceptanceCriteria": [
        "hasPermission(user, role, permission) function created at src/lib/rbac.ts",
        "Checks user's role in organization",
        "Looks up permissions for role",
        "Returns boolean",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Created src/lib/rbac.ts with permission checking functions. Implements checkUserPermission() which retrieves user's role from control_plane.organization_members table and checks permissions via hasPermission(). Provides detailed PermissionCheckResult with granted status and reason. Includes helper functions: getUserRole(), hasPermissionForOrganization() (boolean return), isOrganizationMember(), getOrganizationMembers(). Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Create Permission Middleware",
      "description": "As a platform engineer, I want permission middleware so that I can easily protect routes.",
      "acceptanceCriteria": [
        "requirePermission(permission) middleware created",
        "Checks user permission",
        "Returns 403 if not permitted",
        "Works with Express/Next.js",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Created permission middleware in src/lib/middleware.ts. Added requirePermission(permission, getOrganizationId, handler) middleware that authenticates requests, checks user permissions within an organization, and returns 403 if not permitted. Also added helper middleware: withAuth (authentication only), requireAllPermissions (requires all listed permissions), and requireAnyPermission (requires at least one permission). Middleware integrates with existing authenticateRequest, checkUserPermission from rbac.ts, and Permission types from rbac.types.ts. Supports flexible organization ID extraction from path params, query params, or request body. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Apply Permissions to Project Deletion",
      "description": "As a platform operator, I want only owners to delete projects so that team members can't accidentally delete shared projects.",
      "acceptanceCriteria": [
        "DELETE /api/projects/:id checks permission",
        "Only organization owners or project owners can delete",
        "Returns 403 for non-owners",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Applied permission checking to DELETE /api/projects/[projectId] endpoint in src/app/api/projects/[projectId]/route.ts. Uses requirePermission middleware with Permission.PROJECTS_DELETE. Extracts organization ID from project's tenant_id by fetching project details first before permission check. Only organization owners (who have projects.delete permission) can delete projects. Returns 403 Forbidden for non-owners with detailed error message including required_permission field. Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Apply Permissions to Service Management",
      "description": "As a platform operator, I want only admins and owners to manage services so that developers can't disable critical services.",
      "acceptanceCriteria": [
        "Service enable/disable endpoints check permission",
        "Only admins and owners can manage",
        "Returns 403 for developers/viewers",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Applied permission checking to service management endpoints. Updated POST /api/projects/[projectId]/suspend and POST /api/projects/[projectId]/activate endpoints in src/app/api/projects/[projectId]/suspend/route.ts and activate/route.ts. Both endpoints now use requirePermission middleware with Permission.PROJECTS_MANAGE_SERVICES. Extracts organization ID from project's tenant_id before permission check. Only admins and owners (who have projects.manage_services permission) can suspend or activate projects. Returns 403 Forbidden for developers/viewers with detailed error message including required_permission field. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Apply Permissions to Key Management",
      "description": "As a platform operator, I want only admins and owners to manage API keys so that developers can't create credentials.",
      "acceptanceCriteria": [
        "Key create/delete/revoke endpoints check permission",
        "Only admins and owners can manage keys",
        "Returns 403 for developers/viewers",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Applied permission checking to all key management endpoints. Updated GET /api/api-keys, POST /api/api-keys (create), and DELETE /api/api-keys (revoke) in src/app/api/api-keys/route.ts. Also updated POST /api/keys/[id]/rotate in src/app/api/keys/[id]/rotate/route.ts and DELETE /api/keys/[id]/revoke in src/app/api/keys/[id]/revoke/route.ts. All endpoints now use requirePermission middleware with Permission.PROJECTS_MANAGE_KEYS. Extracts organization ID from project's tenant_id (for create) or from key's associated project (for rotate/revoke). Only admins and owners (who have projects.manage_keys permission) can create, rotate, or revoke API keys. Returns 403 Forbidden for developers/viewers with detailed error message including required_permission field. Added helper functions getOrganizationIdFromProject() and getOrganizationIdFromKey() to resolve organization context. Typecheck passes."
    },
    {
      "id": "US-008",
      "title": "Apply Permissions to User Management",
      "description": "As a platform operator, I want only owners to manage users so that admins can't add other admins.",
      "acceptanceCriteria": [
        "User invite/remove endpoints check permission",
        "Only owners can manage users",
        "Returns 403 for admins and below",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Updated RBAC role permissions to remove projects.manage_users from Admin role (only Owners now have this permission). Updated control-plane-api user management endpoints (POST /v1/orgs/:id/members for invite, PUT /v1/orgs/:id/members/:userId for role update, DELETE /v1/orgs/:id/members/:userId for remove) to use requirePermission middleware with Permission.PROJECTS_MANAGE_USERS. All endpoints now enforce that only organization owners can invite, remove, or change roles of members. Returns 403 Forbidden with detailed error message for non-owners. Updated rbac.types.ts in both src/lib and control-plane-api/src/lib. Typecheck passes."
    },
    {
      "id": "US-009",
      "title": "Update UI Based on Permissions",
      "description": "As a developer, I want the UI to show only actions I can perform so that I don't see buttons I can't use.",
      "acceptanceCriteria": [
        "Permission check in UI components",
        "Delete project button: owners only",
        "Manage services button: admins/owners only",
        "Manage keys button: admins/owners only",
        "Manage users button: owners only",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Created client-side permission checking infrastructure. Added API endpoint at src/app/api/permissions/check/route.ts for checking user permissions. Created React hooks (usePermission, usePermissions) in src/hooks/usePermissions.ts for client-side permission checks. Updated project detail page (src/app/dashboard/projects/[slug]/page.tsx) to conditionally render buttons based on permissions: Delete project button now only shows for owners (canDeleteProject), Create Key button only shows for admins/owners (canManageKeys). The permission checks use project.tenant_id as the organization_id. Note: Manage services and manage users buttons were not present in the current UI implementation, but the permission infrastructure is in place for when they are added. Typecheck passes."
    },
    {
      "id": "US-010",
      "title": "Enforce Database Write Permissions",
      "description": "As a platform operator, I want database writes restricted so that viewers can't modify data.",
      "acceptanceCriteria": [
        "API gateway checks permission for writes",
        "Viewers rejected for INSERT/UPDATE/DELETE",
        "Returns 403 with clear message",
        "Developers and admins can write",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Enforce Studio Permissions",
      "description": "As a platform operator, I want Studio to respect permissions so that viewers can't execute destructive SQL.",
      "acceptanceCriteria": [
        "Studio checks permission before SQL execution",
        "Viewers can only SELECT",
        "Developers can SELECT/INSERT/UPDATE",
        "Admins/owners have full access",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Create Permission Denied Error",
      "description": "As a developer, I want clear permission denied errors so that I understand why I can't perform an action.",
      "acceptanceCriteria": [
        "PERMISSION_DENIED error code defined",
        "Error message explains what permission is needed",
        "Error message explains who to contact",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/RBAC System.md"
}