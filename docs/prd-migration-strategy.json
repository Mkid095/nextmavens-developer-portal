{
  "project": "Migration Strategy",
  "branchName": "flow/migration-strategy",
  "description": "Migrations will happen. You need rollback capability and version tracking. Breaking changes should be marked explicitly. A solid migration strategy prevents deployment disasters and enables safe schema evolution.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Schema Migrations Table",
      "description": "As a platform engineer, I want a schema_migrations table so that I can track which database migrations have been applied.",
      "acceptanceCriteria": [
        "schema_migrations table created in control_plane schema",
        "Columns: version (VARCHAR(50) PRIMARY KEY), description (TEXT), applied_at (TIMESTAMPTZ DEFAULT NOW()), rollback_sql (TEXT), breaking (BOOLEAN DEFAULT FALSE)",
        "Index on applied_at for sorting",
        "Migration script created to create this table first",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Created migrations/001_initial_schema_migrations.sql with schema_migrations table, all required columns, and index. Created src/lib/migrations.ts with runMigrations(), getMigrationStatus(), and rollbackMigration() functions. Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Create Migration Runner Script",
      "description": "As a platform engineer, I want a migration runner script so that I can apply database migrations programmatically.",
      "acceptanceCriteria": [
        "Migration runner created at src/lib/migrations.ts",
        "runMigrations() function applies pending migrations",
        "Migrations in /migrations directory",
        "Migrations numbered: 001_initial.sql, 002_add_columns.sql, etc.",
        "Checks schema_migrations table before running",
        "Records each migration in schema_migrations",
        "Transaction per migration (rollback on failure)",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Enhanced migration runner at src/lib/migrations.ts with transaction-per-migration support. Each migration now runs in its own transaction, so failures don't rollback previously applied migrations. The runner also extracts rollback SQL and breaking flags from migration file comments. Added README.md and template.sql to migrations directory. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Implement Rollback Support",
      "description": "As a platform engineer, I want rollback support so that I can revert bad migrations.",
      "acceptanceCriteria": [
        "rollbackMigration(version) function",
        "Executes rollback_sql from schema_migrations",
        "Removes migration record from schema_migrations",
        "Verifies rollback succeeded",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: rollbackMigration(version) function already implemented at src/lib/migrations.ts:179-220. It executes rollback_sql from schema_migrations table, removes the migration record, and has proper transaction handling with verification. Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Create Migrations Directory Structure",
      "description": "As a platform engineer, I want a standard migrations directory so that migrations are organized and discoverable.",
      "acceptanceCriteria": [
        "/migrations directory created",
        "Naming convention: NNN_description.sql",
        "README in directory explaining conventions",
        "Each migration file includes: up SQL, rollback SQL, breaking flag, description",
        "Template migration file provided",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1
      ],
      "mcpTools": {
        "step1": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: /migrations directory already exists with proper NNN_description.sql naming convention. Added comprehensive README.md explaining conventions, supported metadata (Breaking:, Rollback:), transaction handling, and best practices. Added 000_template.sql as template. Migration runner extracts metadata from comments. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Implement Breaking Change Tracking",
      "description": "As a platform engineer, I want to mark breaking changes so that I know which migrations require special attention.",
      "acceptanceCriteria": [
        "breaking column in schema_migrations",
        "Set to TRUE for breaking changes",
        "Migration runner warns before applying breaking migrations",
        "Requires confirmation for breaking migrations in production",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Added MigrationOptions interface with autoConfirmBreaking, environment, and force options. Added isProductionEnvironment() helper. Added logBreakingChangeWarning() function that displays warning before applying breaking migrations. Updated runMigrations() to check for breaking changes before applying, require confirmation in production (throws error unless autoConfirmBreaking or force is true), and show warning in non-production environments. breaking column already exists in schema_migrations table. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Create Migration Status Command",
      "description": "As a platform engineer, I want to see migration status so that I know which migrations have been applied.",
      "acceptanceCriteria": [
        "migrationStatus() function",
        "Lists all migrations",
        "Shows status: applied, pending",
        "Shows applied_at for applied migrations",
        "Shows breaking flag",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: getMigrationStatus() function already exists at src/lib/migrations.ts:140-174. Returns object with: applied (array of MigrationRecord with version, description, applied_at, rollback_sql, breaking, created_at) and pending (array of version strings). MigrationRecord type includes breaking field. Queries control_plane.schema_migrations table sorted by applied_at DESC. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Test Migrations on Staging",
      "description": "As a platform engineer, I want to test migrations on staging before production so that I catch issues early.",
      "acceptanceCriteria": [
        "Process documented for testing migrations",
        "Migration runner supports --dry-run flag",
        "Dry-run shows what would be applied",
        "Staging environment available",
        "Typecheck passes"
      ],
      "mavenSteps": [
        3
      ],
      "mcpTools": {
        "step3": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Add Migration Locking",
      "description": "As a platform engineer, I want migration locking so that concurrent migrations don't cause conflicts.",
      "acceptanceCriteria": [
        "Migration lock table created",
        "Runner acquires lock before running",
        "Waits if lock held by another process",
        "Releases lock after migration completes",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Created migration_locks table with columns: id, pid, host, acquired_at, migration_version, completed_at. Added index on completed_at for cleanup. Implemented acquireMigrationLock() function that: (1) Creates table if not exists, (2) Cleans up old completed locks (>1 hour), (3) Checks for active locks, (4) Acquires lock if available, (5) Waits with retry if lock held (configurable timeout, default 30s), (6) Returns release function. Updated runMigrations() to acquire lock at start and release in finally block. Tracks pid and hostname for lock identification. Typecheck passes."
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/Migration Strategy.md"
}