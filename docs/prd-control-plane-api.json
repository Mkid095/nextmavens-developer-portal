{
  "project": "NextMavens",
  "branchName": "flow/control-plane-api",
  "description": "Extract control routes into standalone authoritative API service that separates the control plane from the UI layer. This creates the foundational API boundary that CLI, automation, CI/CD, and the developer portal will all consume.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Control Plane API Project Structure",
      "description": "As a platform engineer, I want to create the standalone Control Plane API service so that all governance operations have a first-class API boundary.",
      "acceptanceCriteria": [
        "Next.js project created at /home/ken/control-plane-api/",
        "Project structure includes /app/api with versioned routes",
        "Shared auth.ts library for JWT authentication",
        "Shared db.ts library for database connection pooling",
        "Package.json includes all necessary dependencies",
        "Typecheck passes",
        "Can run development server locally"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Control Plane API service created at control-plane-api/ with versioned routes (/app/api/v1/, /app/api/internal/), shared auth.ts and db.ts libraries. Typecheck passes. Dev server runs successfully."
    },
    {
      "id": "US-002",
      "title": "Implement Projects CRUD API",
      "description": "As a platform operator, I want to create, read, update, and delete projects via REST API so that I can manage projects programmatically.",
      "acceptanceCriteria": [
        "POST /v1/projects - Create new project",
        "GET /v1/projects - List all projects (with filtering)",
        "GET /v1/projects/:id - Get project details",
        "PUT /v1/projects/:id - Update project",
        "DELETE /v1/projects/:id - Delete project (soft delete)",
        "All endpoints require authentication",
        "Request validation on all inputs",
        "Typecheck passes",
        "API returns JSON responses with standard error format"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Implemented full Projects CRUD API with Zod validation, authentication via JWT, ownership checks, filtering support (by status, limit, offset), soft delete (status='archived'), and standard JSON error responses. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Implement Organizations API",
      "description": "As a platform operator, I want to manage organizations and team membership via API so that I can programmatically handle multi-tenant scenarios.",
      "acceptanceCriteria": [
        "POST /v1/orgs - Create organization",
        "GET /v1/orgs - List organizations",
        "GET /v1/orgs/:id - Get organization details",
        "PUT /v1/orgs/:id - Update organization",
        "POST /v1/orgs/:id/members - Add member",
        "DELETE /v1/orgs/:id/members/:userId - Remove member",
        "PUT /v1/orgs/:id/members/:userId - Update member role",
        "All endpoints require authentication",
        "Authorization checks ensure only owners can manage members",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Full Organizations API implemented with all CRUD operations and member management. Added Zod validation schemas for organizations (create, update, addMember, updateMemberRole). Created /v1/orgs route.ts with GET (list orgs where user is owner/member) and POST (create org with slug generation). Created /v1/orgs/[id]/route.ts with GET (org details with members list) and PUT (update org, owners/admins only). Created /v1/orgs/[id]/members/route.ts with POST (add member, owners only). Created /v1/orgs/[id]/members/[userId]/route.ts with PUT (update role, owners only) and DELETE (remove member, owners only). All endpoints require JWT authentication. Authorization checks ensure only owners can manage members. Prevents removing/changing owner's role. Slug auto-generated from name. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Implement API Keys Management API",
      "description": "As a developer, I want to create, rotate, and revoke API keys via API so that I can manage credentials programmatically.",
      "acceptanceCriteria": [
        "POST /v1/keys - Create new API key with type and scopes",
        "GET /v1/keys - List keys for project",
        "GET /v1/keys/:id - Get key details (show value only on creation)",
        "PUT /v1/keys/:id/rotate - Rotate key with grace period",
        "DELETE /v1/keys/:id/revoke - Revoke key immediately",
        "GET /v1/keys/:id/usage - Get usage statistics",
        "Key types supported: public, secret, service_role, mcp",
        "Scopes enforced per key type",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Full API Keys Management API implemented in control-plane-api. Added Zod validation schemas for API keys (create, list). Added API key generation functions (generateApiKey, hashApiKey, getKeyPrefix) with DEFAULT_API_KEY_SCOPES. Created /v1/keys/route.ts with GET (list keys with filtering by project_id, key_type, environment, limit, offset) and POST (create key with type, environment, scopes). Created /v1/keys/[id]/route.ts with GET (get key details without secret value). Created /v1/keys/[id]/rotate/route.ts with POST (rotate key with 24-hour grace period for old key). Created /v1/keys/[id]/revoke/route.ts with DELETE (revoke key immediately by setting status=revoked). Created /v1/keys/:id/usage with GET (usage statistics including last_7_days, last_30_days, success_error_rate). All endpoints require JWT authentication with ownership verification. Key types: public, secret, service_role, mcp with default scopes per type. Typecheck passes."
    },
    {
      "id": "US-009",
      "title": "Implement Internal Snapshot Endpoint",
      "description": "As a data plane service, I want to fetch a cached snapshot of control plane state so that I can enforce governance without hitting the control database directly.",
      "acceptanceCriteria": [
        "GET /internal/snapshot?project_id=xxx returns complete project state",
        "Response includes: project status, enabled services, limits, quotas, environment",
        "Snapshot cached with 30-60s TTL",
        "Version field for cache invalidation",
        "Returns 503 if snapshot unavailable (fail closed)",
        "No authentication required (internal endpoint)",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Update Developer Portal to Consume Control Plane API",
      "description": "As a developer, I want the developer portal UI to call the Control Plane API instead of accessing the database directly so that all operations go through the authoritative API boundary.",
      "acceptanceCriteria": [
        "Remove direct DB queries from developer portal API routes",
        "All project operations call Control Plane API",
        "All API key operations call Control Plane API",
        "Authentication shared between portal and control plane",
        "Error handling uses standard error format",
        "Typecheck passes",
        "All existing functionality preserved"
      ],
      "mavenSteps": [
        4,
        7,
        10
      ],
      "mcpTools": {
        "step4": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement Usage and Quotas API",
      "description": "As a platform operator, I want to track usage and manage quotas via API so that I can monitor and control resource consumption.",
      "acceptanceCriteria": [
        "GET /v1/usage/:projectId - Get current usage metrics",
        "POST /v1/usage/check - Check if operation is within quota",
        "PUT /v1/quotas/:projectId - Update project quotas",
        "GET /v1/quotas/:projectId - Get current quotas",
        "Usage metrics aggregated by service and time period",
        "Quota warnings returned at 80%, 90%, 100%",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement Jobs API",
      "description": "As a platform operator, I want to query job status and retry failed jobs via API so that I can monitor and manage async operations.",
      "acceptanceCriteria": [
        "GET /v1/jobs - List jobs with filtering",
        "GET /v1/jobs/:id - Get job details and status",
        "POST /v1/jobs/:id/retry - Retry failed job",
        "DELETE /v1/jobs/:id - Cancel pending job",
        "Job types: provision_project, rotate_key, deliver_webhook, export_backup, check_usage_limits",
        "Status tracking: pending, running, failed, completed",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement Audit Logs API",
      "description": "As a platform operator, I want to query audit logs via API so that I can investigate who did what and when.",
      "acceptanceCriteria": [
        "GET /v1/audit - Query audit logs with filtering",
        "Filters: actor_id, action, target_type, date_range",
        "Returns actor details, action, target, metadata, timestamp",
        "Pagination support",
        "Export to CSV endpoint",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement Webhooks API",
      "description": "As a developer, I want to manage webhook subscriptions via API so that I can integrate with external systems.",
      "acceptanceCriteria": [
        "POST /v1/webhooks - Register webhook URL for events",
        "GET /v1/webhooks - List webhooks for project",
        "DELETE /v1/webhooks/:id - Remove webhook",
        "PUT /v1/webhooks/:id - Update webhook",
        "Event types: project.created, user.signedup, file.uploaded, key.rotated, etc.",
        "Webhook secret for signature verification",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement Health Check Endpoint",
      "description": "As a platform operator, I want to check the health of the Control Plane API and its dependencies so that I can monitor system status.",
      "acceptanceCriteria": [
        "GET /internal/health returns health status",
        "Response includes: status, version, uptime",
        "Dependencies section checks: database, redis (if used)",
        "Each dependency shows status and latency",
        "Returns 200 if healthy, 503 if any dependency unhealthy",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement API Versioning",
      "description": "As a platform operator, I want to version the Control Plane API so that I can introduce breaking changes without disrupting existing clients.",
      "acceptanceCriteria": [
        "Current version accessible at /v1/",
        "Version returned in response headers (X-API-Version)",
        "Deprecation warnings in headers for old versions",
        "Documentation clearly indicates version differences",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/NextMavens.md"
}