{
  "project": "Environment Parity",
  "branchName": "flow/environment-parity",
  "description": "As a developer, I want infinite webhook retries in dev so that testing webhooks is reliable.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add Environment Field to Projects",
      "description": "As a platform engineer, I want projects to have an environment field so that I can apply different rules based on environment.",
      "acceptanceCriteria": [
        "projects table updated with environment column",
        "Environment enum: prod, dev, staging",
        "Default value: prod",
        "Migration script created",
        "Existing projects set to prod",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Implemented environment column in projects table with migration script. Added environment type definitions and updated API routes to support environment field. Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Add Environment Field to API Keys",
      "description": "As a developer, I want API keys to be scoped to environments so that dev keys don't work in production.",
      "acceptanceCriteria": [
        "api_keys table updated with environment column",
        "Environment enum: prod, dev, staging",
        "Key must match project environment to work",
        "Migration script created",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Migration script 014_create_api_keys_table.sql creates api_keys table with environment column (prod, dev, staging). Updated TypeScript types to align environment values. Created environment-validation.ts with validateKeyEnvironment() function to ensure keys only work in matching project environment. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Create Environment Config Helper",
      "description": "As a platform engineer, I want a getEnvironmentConfig() helper so that I can easily get environment-specific behavior.",
      "acceptanceCriteria": [
        "Helper created at src/lib/environment.ts",
        "Takes environment as parameter",
        "Returns config object with: rate_limit_multiplier, auto_suspend_enabled, log_level, max_webhook_retries",
        "Prod: rate_limit_multiplier=1, auto_suspend=true, log_level=info, retries=3",
        "Dev: rate_limit_multiplier=10, auto_suspend=false, log_level=debug, retries=infinite",
        "Staging: rate_limit_multiplier=5, auto_suspend=false, log_level=debug, retries=5",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Helper created at src/lib/environment.ts with getEnvironmentConfig() function. Takes environment as parameter ('prod' | 'dev' | 'staging'). Returns config object with rate_limit_multiplier, auto_suspend_enabled, log_level, max_webhook_retries. Prod: rate_limit_multiplier=1, auto_suspend_enabled=true, log_level=info, max_webhook_retries=3. Dev: rate_limit_multiplier=10, auto_suspend_enabled=false, log_level=debug, max_webhook_retries=null (infinite). Staging: rate_limit_multiplier=5, auto_suspend_enabled=false, log_level=debug, max_webhook_retries=5. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Implement Different Rate Limits per Environment",
      "description": "As a developer, I want higher rate limits in dev so that I can test without hitting limits.",
      "acceptanceCriteria": [
        "Rate limit checking uses environment config",
        "Dev environment gets 10x rate limit",
        "Staging gets 5x rate limit",
        "Prod gets standard rate limit",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Added mapSnapshotEnvironment() to src/lib/environment.ts to convert snapshot environment types (production/development/staging) to config types (prod/dev/staging). Updated checkRateLimit() in src/lib/api-gateway/snapshot-client.ts to use getEnvironmentConfig() and apply rate_limit_multiplier. Dev gets 10x, staging gets 5x, prod gets 1x. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Disable Auto-Suspend in Dev",
      "description": "As a developer, I want auto-suspend disabled in dev so that my testing doesn't get interrupted.",
      "acceptanceCriteria": [
        "Auto-suspend job checks environment config",
        "Dev and staging environments skip auto-suspend",
        "Only prod environment auto-suspends",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Updated checkAllProjectsForSuspension() in src/features/abuse-controls/lib/suspensions.ts to check environment config. Added import for getEnvironmentConfig and Environment type. Query now fetches environment column from projects table. For each project, gets envConfig.auto_suspend_enabled and skips suspension check if false (dev and staging). Only prod environment (auto_suspend_enabled=true) gets auto-suspended. Added logging for skipped projects. Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Implement Verbose Logging in Dev",
      "description": "As a developer, I want verbose logging in dev so that I can debug issues easily.",
      "acceptanceCriteria": [
        "Log level set from environment config",
        "Dev and staging use debug level",
        "Prod uses info level (or sampled)",
        "Debug logs include full request/response bodies",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Created environment-aware logger at src/lib/logger.ts with LogLevel type (debug, info, warn, error). Includes setLogLevel() to set log level from environment config (dev/staging=debug, prod=info). Production uses 10% sampling for debug/info logs via shouldSample(). Debug mode includes full request/response bodies via formatMetadata() which serializes full metadata with indentation. Provides Logger class for scoped logging, createLogger() factory, logRequest(), logResponse(), logError() helpers, and initializeLogger() for startup initialization. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Implement Infinite Webhook Retries in Dev",
      "description": "As a developer, I want infinite webhook retries in dev so that testing webhooks is reliable.",
      "acceptanceCriteria": [
        "Webhook retry logic uses environment config",
        "Dev environment retries indefinitely",
        "Staging retries 5 times",
        "Prod retries 3 times",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Webhook retry logic uses getEnvironmentConfig() from src/lib/environment.ts which provides environment-specific max_webhook\u6253\u8d25_retries (null for infinite in dev, 5 for staging, 3 for prod). Dev webhooks retry indefinitely. Typecheck passes."
    },
    {
      "id": "US-008",
      "title": "Add Environment Selector in UI",
      "description": "As a developer, I want to select environment when creating projects so that I can set up dev/staging/prod environments.",
      "acceptanceCriteria": [
        "Environment dropdown in project creation form",
        "Options: Production, Development, Staging",
        "Default: Production",
        "Help text explaining differences",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Added environment selector dropdown to project creation form in src/app/dashboard/page.tsx. Options include Production (prod), Development (dev), and Staging (staging) with Production as default. Added help text explaining the differences between environments: Production has standard limits and auto-suspend, Development has 10x limits with no auto-suspend and infinite webhook retries, Staging has 5x limits with 5 webhook retries. Updated API route to pass environment to control plane. Typecheck passes."
    },
    {
      "id": "US-009",
      "title": "Show Environment Indicators in UI",
      "description": "As a developer, I want to see environment indicators so that I know which environment I'm working with.",
      "acceptanceCriteria": [
        "Environment badge shown on project detail page",
        "Color-coded: Prod (green), Dev (blue), Staging (yellow)",
        "Environment shown in project list",
        "Warning when working in prod environment",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Added environment badge to project detail page header in src/app/dashboard/projects/[slug]/page.tsx. Badge is color-coded: Production (green/emerald), Development (blue), Staging (yellow). Added production warning banner that displays when working in prod environment with AlertCircle icon. Added environment badges to project list in dashboard page src/app/dashboard/page.tsx with same color coding. Updated Project interfaces in both files to include environment field. Typecheck passes."
    },
    {
      "id": "US-010",
      "title": "Environment-Specific API Key Prefixes",
      "description": "As a developer, I want API keys to have environment-specific prefixes so that I can easily identify key environment.",
      "acceptanceCriteria": [
        "Prod keys: nm_live_pk_, nm_live_sk_",
        "Dev keys: nm_dev_pk_, nm_dev_sk_",
        "Staging keys: nm_staging_pk_, nm_staging_sk_",
        "Prefix set based on project environment",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Environment-specific API key prefixes implemented in control-plane-api/src/lib/auth.ts. getKeyPrefix() function generates prefixes: nm_live_pk_/nm_live_sk_ for prod, nm_dev_pk_/nm_dev_sk_ for dev, nm_staging_pk_/nm_staging_sk_ for staging. Prefix is set based on project environment via mapProjectEnvironmentToKeyEnvironment() function. Keys are created in POST /v1/keys route using the project's environment to determine the correct prefix. Typecheck passes."
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/Environment Parity.md",
  "id": "US-007",
  "title": "Implement Infinite Webhook Retries in Dev",
  "acceptanceCriteria": [
    "Webhook retry logic uses environment config",
    "Dev environment retries indefinitely",
    "Staging retries 5 times",
    "Prod retries 3 times",
    "Typecheck passes"
  ],
  "mavenSteps": [
    1,
    2,
    7,
    10
  ],
  "mcpTools": {
    "step1": [],
    "step2": [],
    "step7": [],
    "step10": []
  },
  "priority": 2,
  "passes": true,
  "notes": "Completed: Implemented environment-aware webhook retry logic in src/features/webhooks/lib/webhook-delivery.ts. Added getProjectEnvironment() function to fetch project environment from database and map snapshot environment types to config types. Updated deliverWebhook() function to use getEnvironmentConfig() and apply max_webhook_retries setting. Dev environment gets infinite retries (null), staging gets 5 retries, prod gets 3 retries. Retry loop handles both Infinity and finite maxRetries values. Includes exponential backoff calculation with 5-minute cap. HMAC-SHA256 signature generation. Proper error handling for 4xx errors (no retry except 408, 429) and 5xx errors (retry). Typecheck passes."
}