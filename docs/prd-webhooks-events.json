{
  "project": "Webhooks & Events System",
  "branchName": "flow/webhooks-events",
  "description": "Outbound event delivery to external systems. Integrations: Stripe (billing), analytics (Mixpanel, Amplitude), automations (Zapier, Make), internal webhooks. Event types: project created, user signed up, file uploaded, key rotated, function executed. Delivery with retry.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Webhooks Table",
      "description": "As a platform engineer, I want a webhooks table so that I can store webhook configurations.",
      "acceptanceCriteria": [
        "webhooks table created in control_plane schema",
        "Columns: id, project_id, event, target_url, secret, enabled, created_at",
        "Event is VARCHAR for flexibility",
        "Secret for signature verification",
        "Index on project_id and event",
        "Migration script created",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Created migration 009_create_webhooks_table.sql with webhooks table in control_plane schema. Includes id (UUID PK), project_id (UUID FK), event (VARCHAR 100), target_url (VARCHAR 2048), secret (VARCHAR 255, auto-generated hex), enabled (BOOLEAN, default TRUE), consecutive_failures (INTEGER, default 0), updated_at (TIMESTAMPTZ), created_at. Indexes on project_id, event, and (project_id, event). Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Create Event Log Table",
      "description": "As a platform engineer, I want an event log table so that I can track webhook delivery.",
      "acceptanceCriteria": [
        "event_log table created in control_plane schema",
        "Columns: id, project_id, event_type, payload (JSONB), delivered_at, status, created_at",
        "Status enum: pending, delivered, failed",
        "Index on project_id and status",
        "Migration script created",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Migration 010_create_event_log_table.sql created with event_log table in control_plane schema. All required columns: id (UUID PK), project_id (UUID FK to projects.id), webhook_id (UUID FK to webhooks.id, nullable), event_type (VARCHAR 100), payload (JSONB with default {}), delivered_at (TIMESTAMPTZ, nullable), status (VARCHAR 20 with CHECK constraint for pending/delivered/failed), response_code (INTEGER, nullable), response_body (TEXT, nullable), retry_count (INTEGER, default 0), created_at. Indexes on (project_id, status), project_id, event_type, status, and created_at DESC. Migration record inserted into schema_migrations. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Define Event Types",
      "description": "As a platform engineer, I want event types defined so that webhooks can be configured appropriately.",
      "acceptanceCriteria": [
        "Events defined: project.created, project.suspended, project.deleted",
        "Events: user.signedup, user.deleted",
        "Events: file.uploaded, file.deleted",
        "Events: key.created, key.rotated, key.revoked",
        "Events: function.executed",
        "Events: usage.threshold",
        "Documented in code",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: EventType type defined in src/features/webhooks/types/index.ts with all required event types (project.*, user.*, file.*, key.*, function.executed, usage.threshold). Documented with JSDoc comment referencing US-003. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Implement Webhook Registration",
      "description": "As a developer, I want to register webhooks so that I receive event notifications.",
      "acceptanceCriteria": [
        "POST /api/webhooks endpoint",
        "Request: project_id, event, target_url",
        "Generates secret for signature",
        "Returns webhook with secret (show once)",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: POST /api/webhooks endpoint implemented at control-plane-api/src/app/api/v1/webhooks/route.ts (lines 144-209). Accepts project_id, event, target_url (plus optional secret, enabled). Validates request body using Zod schema. Validates project ownership via validateProjectOwnership_reload tentamen undefined. Generates secret using randomBytes(32).toString('hex') if not provided. Returns webhook with secret shown once. Typecheck passes."
    },
    {
      "id": "US-005",
      "title": "Implement Webhook Delivery",
      "description": "As a platform engineer, I want webhooks delivered reliably so that external systems receive events.",
      "acceptanceCriteria": [
        "Background job processes pending event_log entries",
        "POSTs payload to target_url",
        "Signs with shared secret (HMAC)",
        "Updates event_log status",
        "Retry on failure (5x with exponential backoff)",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Background job (webhook-processor-job.ts, 439 lines) with runWebhookProcessor() function. Processes pending event_log entries with exponential backoff retry (calculateBackoffDelay: 1s * 2^retry_count with jitter, max 60s). POSTs payload to target_url with HMAC-SHA256 signature (X-Webhook-Signature header). Updates event_log status (pending/delivered/failed), response_code, response_body, delivered_at. Implements 5 retries with consecutive_failures tracking. Auto-disables webhooks after 5 consecutive failures (US-011 integration). Typecheck passes."
    },
    {
      "id": "US-006",
      "title": "Implement Signature Verification",
      "description": "As a webhook consumer, I want to verify webhook signatures so that I know events are authentic.",
      "acceptanceCriteria": [
        "Signature header: X-Webhook-Signature",
        "HMAC-SHA256 of payload with secret",
        "Documentation shows how to verify",
        "Example code provided",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Created signature verification library at src/features/webhooks/lib/webhook-signature.ts (270+ lines) with verifyWebhookSignature(), generateSignature(), extractSignature(), and parseVerifiedWebhook() helper functions. Verification uses HMAC-SHA256 with constant-time comparison to prevent timing attacks. The X-Webhook-Signature header (format: sha256=<hex>) is already sent by webhook-delivery.ts (line 103). Documentation created at docs/webhooks-signature-verification.md with comprehensive guide including how signature verification works, headers reference, verification steps, and example code in Node.js/TypeScript (Express, Next.js), Python (Flask), and Go. Includes security best practices (constant-time comparison, timestamp checks, proper status codes, idempotency handling) and troubleshooting section. Typecheck passes."
    },
    {
      "id": "US-007",
      "title": "Emit Events on Actions",
      "description": "As a platform engineer, I want events emitted on key actions so that webhooks are triggered.",
      "acceptanceCriteria": [
        "Project creation emits project.created",
        "User signup emits user.signedup",
        "File upload emits file.uploaded",
        "Key rotation emits key.rotated",
        "Events created in event_log",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 1,
      "passes": true,
      "notes": "Completed: Implemented event emissions for all four required events. project.created: Emitted at control-plane-api/src/app/api/v1/projects/route.ts with project_id, project_name, tenant_id, environment, developer_id, created_at. user.signedup: Emitted at src/app/api/developer/register/route.ts using new emitPlatformEvent function (for platform events without project_id) with user_id, email, name, organization, created_at. file.uploaded: Emitted at src/app/api/storage/upload/route.ts with project_id, file_name, file_size, content_type, storage_path, uploaded_at. key.rotated: Emitted at control-plane-api/src/app/api/v1/keys/[id]/rotate/route.ts with project_id, old_key_id, new_key_id, key_name, key_type, rotated_at, expires_at. Created emitPlatformEvent function in webhook-delivery.ts for platform-level events (uses system project_id '00000000-0000-0000-0000-000000000000'). All emissions use fire-and-forget pattern. Events are created in event_log table. Typecheck passes."
    },
    {
      "id": "US-008",
      "title": "Create Webhooks API",
      "description": "As a developer, I want to manage webhooks via API so that I can automate webhook configuration.",
      "acceptanceCriteria": [
        "GET /api/webhooks - List webhooks",
        "GET /api/webhooks/:id - Get webhook details",
        "PUT /api/webhooks/:id - Update webhook",
        "DELETE /api/webhooks/:id - Delete webhook",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: All Webhooks API endpoints implemented. GET /api/webhooks (control-plane-api/src/app/api/v1/webhooks/route.ts:40-142) lists webhooks with filters for project_id, event, enabled status, limit, and offset. GET /api/webhooks/:id (control-plane-api/src/app/api/v1/webhooks/[id]/route.ts:35-95) returns webhook details. PUT /api/webhooks/:id (control-plane-api/src/app/api/v1/webhooks/[id]/route.ts:98-216) updates webhook fields (event, target_url, secret, enabled). DELETE /api/webhooks/:id (control-plane-api/src/app/api/v1/webhooks/[id]/route.ts:219-273) deletes webhook. All endpoints include authentication, project ownership validation, and proper error handling. Validation schemas defined in control-plane-api/src/lib/validation.ts (createWebhookSchema, updateWebhookSchema, listWebhooksQuerySchema)."
    },
    {
      "id": "US-009",
      "title": "Create Webhooks UI",
      "description": "As a developer, I want a webhooks UI so that I can manage webhooks without API calls.",
      "acceptanceCriteria": [
        "Webhooks management page created",
        "Lists all webhooks for project",
        "Create webhook form",
        "Event type selector",
        "Target URL input",
        "Enable/disable toggle",
        "Test webhook button",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Webhooks management UI at src/app/dashboard/projects/[slug]/webhooks/page.tsx (603 lines). Lists all webhooks for project with event type, target URL, enabled status, created date, and consecutive failures. Create webhook form with event type dropdown (all 12 event types), target URL input with validation, enable toggle defaulting to true. Test webhook button with visual feedback (success/error states). Enable/disable toggle with animated switches. Delete webhook button with confirmation modal. Secret display only on creation (show once with copy button). Error handling with user-friendly messages. Loading states for all async operations. Responsive design with Framer Motion animations. Typecheck passes."
    },
    {
      "id": "US-010",
      "title": "Show Webhook History",
      "description": "As a developer, I want to see webhook delivery history so that I can troubleshoot.",
      "acceptanceCriteria": [
        "Webhook history section",
        "Shows: event type, delivered_at, status, response code",
        "Shows retry count",
        "Retry failed webhooks button",
        "Filter by status",
        "Typecheck passes"
      ],
      "mavenSteps": [
        5,
        10
      ],
      "mcpTools": {
        "step5": [],
        "step10": []
      },
      "priority": 2,
      "passes": true,
      "notes": "Completed: Created GET /api/v1/webhooks/history endpoint in control-plane-api with filtering by project_id, webhook_id, event_type, status, and pagination support. Added EventLog types to webhook.types.ts with all required fields (id, project_id, webhook_id, event_type, status, response_code, response_body, retry_count, delivered_at, created_at). Updated control-plane-client.ts with listEventLogs() method. Added webhook history UI section to webhooks page with event type, delivered_at, status, response code display, retry count indicator, retry failed webhooks button, and status filter (all/delivered/failed/pending). Added View History button in page header and individual webhook cards. Typecheck passes."
    },
    {
      "id": "US-011",
      "title": "Disable Failed Webhooks",
      "description": "As a platform operator, I want failed webhooks auto-disabled so that delivery attempts don't continue forever.",
      "acceptanceCriteria": [
        "After 5 consecutive failures, webhook disabled",
        "Sets enabled = FALSE",
        "Notification sent to project owner",
        "Can be re-enabled manually",
        "Typecheck passes"
      ],
      "mavenSteps": [
        1,
        2,
        7,
        10
      ],
      "mcpTools": {
        "step1": [],
        "step2": [],
        "step7": [],
        "step10": []
      },
      "priority": 2,
      "passes": false,
      "notes": ""
    }
  ],
  "relatedPRDs": [],
  "consolidatedMemory": "",
  "lessonsLearned": "",
  "memorialFile": "docs/memory/Webhooks & Events System.md"
}