# Docker Compose for Integration Testing
# This compose file exposes the database to localhost for running integration tests
# Usage: docker compose -f docker-compose.test.yml up --build
# Then run: INTEGRATION_TEST=true DATABASE_URL="postgresql://nextmavens:password@localhost:15432/nextmavens" npm test -- src/lib/provisioning/__tests__/integration.test.ts

services:
  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile.test
    env_file:
      - .env
    environment:
      - INTEGRATION_TEST=true
      - DATABASE_URL=${DATABASE_URL}
      - NODE_ENV=test
    volumes:
      - .:/app
      - /home/ken/developer-portal/node_modules:/app/node_modules:ro
    working_dir: /app
    command: sh -c "./node_modules/.bin/vitest run src/lib/provisioning/__tests__/integration.test.ts"
    depends_on:
      - db-proxy
    networks:
      - dokploy-network

  # Port forwarding proxy to expose database to tests
  db-proxy:
    image: alpine/socat
    command: tcp-listen:5432,fork,reuseaddr tcp-connect:dokploy-postgres:5432
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
